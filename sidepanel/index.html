<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADO to PA Copypaster</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!--
    Script loading order matters for Alpine.js store registration:

      1. app.js (synchronous, no defer) â€” registers the 'alpine:init' listener
         that creates the store and wires the TAB_CHANGED message handler.
         MUST execute before Alpine starts so the listener is already in place
         when Alpine fires 'alpine:init' during its own startup.

      2. alpine.min.js (defer) â€” waits for the DOM to be fully parsed, then
         starts Alpine.  Alpine fires 'alpine:init', our listener runs, the
         store is registered, and Alpine proceeds to walk the DOM.

    Both scripts are local files (no CDN) to comply with Chrome MV3's default
    Content Security Policy, which blocks external script sources.
  -->
  <script src="app.js"></script>
  <script defer src="../lib/alpine.min.js"></script>

  <!-- â”€â”€ Root application wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!--
    x-data="" is required to activate Alpine.js on this element and all its
    descendants. Without x-data in scope, Alpine ignores every directive in the
    DOM â€” x-show stays inert, @click handlers never fire, :class bindings are
    never evaluated.  An empty x-data creates a component scope that still gives
    full access to $store.app via Alpine's global store mechanism.
  -->
  <div id="app" x-data>

    <!-- â”€â”€ Tab Bar (SPEC.md Â§7.1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!--
      role="tablist" + role="tab" + aria-selected follows ARIA tabs pattern.
      Active tab is tracked in $store.app.activeTab ("user" | "admin").
      The .tab-btn--active class drives the visual underline indicator in CSS.
    -->
    <nav class="tab-bar" role="tablist" aria-label="Main navigation">
      <button
        role="tab"
        class="tab-btn"
        :class="{ 'tab-btn--active': $store.app.activeTab === 'user' }"
        :aria-selected="$store.app.activeTab === 'user'"
        @click="$store.app.setTab('user')"
      >User</button>
      <button
        role="tab"
        class="tab-btn"
        :class="{ 'tab-btn--active': $store.app.activeTab === 'admin' }"
        :aria-selected="$store.app.activeTab === 'admin'"
        @click="$store.app.setTab('admin')"
      >Admin</button>
    </nav>

    <!-- â”€â”€ User Tab Panel (SPEC.md Â§7.2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!--
      x-show toggles CSS display instead of removing the element from the DOM.
      This preserves the field-results list when the user briefly switches to
      Admin and returns â€” no re-fetch needed. (design D-5)
    -->
    <!-- No x-cloak: User tab is the default â€” it starts visible, no flash possible -->
    <div id="tab-user" role="tabpanel" aria-label="User" x-show="$store.app.activeTab === 'user'">

      <!-- Page Context Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!--
        Three mutually exclusive rows, each shown based on pageType.
        Each row carries both an icon and descriptive text â€” never icon-only â€”
        so the state is accessible to screen readers (SPEC.md Â§11 Phase 11 note).
        The coloured dot is aria-hidden because the surrounding text already
        conveys the meaning.
      -->
      <div class="context-banner" role="status" aria-live="polite" aria-atomic="true">

        <div class="context-banner__row context-banner__row--ado"
             x-show="$store.app.pageType === 'ado'">
          <span class="context-dot" aria-hidden="true">ðŸ”µ</span>
          <span>Azure DevOps Initiative detected. Ready to copy.</span>
        </div>

        <div class="context-banner__row context-banner__row--pa"
             x-show="$store.app.pageType === 'pa'">
          <span class="context-dot" aria-hidden="true">ðŸŸ¢</span>
          <span>PowerApps form detected. Ready to paste.</span>
        </div>

        <div class="context-banner__row context-banner__row--unsupported"
             x-show="$store.app.pageType === 'unsupported'">
          <span class="context-dot" aria-hidden="true">âšª</span>
          <span>This page is not supported. Navigate to an ADO Initiative or a PowerApps form.</span>
        </div>

      </div><!-- /context-banner -->

      <!-- Copy / Paste Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- Phase 7 (Copy) and Phase 10 (Paste) will populate this section. -->
      <div class="action-buttons">
        <!-- TODO Phase 7:  Copy Initiative button + spinner + Overwrite badge -->
        <!-- TODO Phase 10: Paste to PowerApps button + spinner               -->
      </div>

      <!-- Field Status List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- Phase 7 / 10 will render one row per FieldResult after operations. -->
      <div class="field-results">
        <!-- TODO Phase 7:  render fieldResults after Copy  -->
        <!-- TODO Phase 10: render fieldResults after Paste -->
      </div>

    </div><!-- /tab-user -->

    <!-- â”€â”€ Admin Tab Panel (SPEC.md Â§7.3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!--
      x-cloak prevents the admin panel from briefly flashing visible before
      Alpine initialises and applies x-show. The [x-cloak] CSS rule sets
      display:none immediately at parse time; Alpine removes the attribute
      once it has evaluated the x-show expression.
    -->
    <div id="tab-admin" role="tabpanel" aria-label="Admin" x-show="$store.app.activeTab === 'admin'" x-cloak>

      <!-- â”€â”€ Settings Section (SPEC.md Â§7.3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!--
        Task 4.1 â€” Overwrite Mode toggle.
        @change passes the checkbox's boolean value to setOverwriteMode()
        rather than assigning directly ($store.app.settings.overwriteMode = x)
        because the Alpine CSP build silently drops assignment expressions in
        directive handlers. Method calls are the correct CSP-safe pattern.
      -->
      <section class="settings-section">
        <h2 class="settings-section__heading">âš™ Settings</h2>
        <label class="overwrite-mode-label">
          <input
            type="checkbox"
            class="overwrite-mode-checkbox"
            :checked="$store.app.getOverwriteMode()"
            @change="$store.app.setOverwriteMode($event.target.checked)"
          />
          Overwrite Mode â€” overwrite existing PA field values during paste
        </label>
      </section>

      <!-- â”€â”€ Field Mappings Section (SPEC.md Â§7.3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section class="mapping-section">

        <!-- Section header + add button â€” Task 5.1 -->
        <div class="mapping-section__header">
          <span class="mapping-section__title">â”€â”€ Field Mappings â”€â”€</span>
          <button
            class="btn btn--small btn--primary"
            @click="$store.app.openAddForm()"
          >+ Add Mapping</button>
        </div>

        <!-- Empty-state message â€” Task 5.3 -->
        <!--
          Shown when there are no mappings. Uses getMappings() rather than
          settings?.mappings because the CSP expression parser does not support
          optional chaining (?.) or nullish coalescing (??).
        -->
        <p
          class="empty-state"
          x-show="$store.app.getMappings().length === 0"
        >No mappings configured yet. Click + Add Mapping to get started.</p>

        <!-- Mapping list â€” Task 5.2 -->
        <!--
          x-for iterates over settings.mappings.  The :key directive uses
          mapping.id so Alpine can efficiently patch the DOM when a mapping is
          added, removed, or reordered without re-rendering the entire list.
        -->
        <ul class="mapping-list" role="list">
          <template x-for="mapping in $store.app.getMappings()" :key="mapping.id">
            <li class="mapping-row">

              <!-- Label + fieldType badge -->
              <div class="mapping-row__info">
                <span class="mapping-row__label" x-text="mapping.label"></span>
                <!--
                  :class uses object syntax with explicit comparisons â€” template
                  literals are not supported by the CSP expression parser.
                -->
                <span
                  class="badge"
                  :class="{ 'badge--text': mapping.fieldType === 'text', 'badge--lookup': mapping.fieldType === 'lookup', 'badge--choice': mapping.fieldType === 'choice' }"
                  x-text="mapping.fieldType"
                ></span>
              </div>

              <!-- Controls: enabled toggle + edit + delete -->
              <div class="mapping-row__controls">

                <!--
                  Enabled toggle â€” @change fires toggleEnabled() rather than
                  directly mutating mapping.enabled because direct assignment
                  inside event directives is not supported by the CSP build.
                -->
                <label class="mapping-row__enabled-label" title="Enabled">
                  <input
                    type="checkbox"
                    class="mapping-row__enabled-checkbox"
                    :checked="mapping.enabled"
                    @change="$store.app.toggleEnabled(mapping.id)"
                  />
                  <span class="sr-only">Enabled</span>
                </label>

                <button
                  class="btn btn--small btn--secondary"
                  @click="$store.app.openEditForm(mapping.id)"
                >Edit</button>

                <button
                  class="btn btn--small btn--danger"
                  @click="$store.app.deleteMapping(mapping.id)"
                >Delete</button>

              </div><!-- /mapping-row__controls -->
            </li>
          </template>
        </ul><!-- /mapping-list -->

        <!-- â”€â”€ Mapping Form â€” Tasks 6.1â€“6.5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <!--
          x-show toggles the form panel.  The form stays in the DOM (x-show,
          not x-if) so that the adminMappingForm x-data component can register
          its $watch listener in init() even when the form is hidden â€” if we
          used x-if, the component would be destroyed and re-created on every
          open, resetting the $watch binding.

          x-data="adminMappingForm" mounts the local draft state component
          registered via Alpine.data() in app.js. The name is referenced without
          calling parentheses â€” Alpine.data() handles calling the factory function
          internally. Using the registered name (not a bare global function call)
          is required by the CSP build. (design D-1)
        -->
        <div
          class="mapping-form"
          x-show="$store.app.showMappingForm"
          x-data="adminMappingForm"
        >

          <!-- Form heading â€” "Add Mapping" or "Edit Mapping" -->
          <!--
            Uses getFormTitle() store method rather than an inline ternary so
            the expression is a trivial method call â€” no operator ambiguity for
            the CSP parser.
          -->
          <h3
            class="mapping-form__heading"
            x-text="$store.app.getFormTitle()"
          ></h3>

          <!-- Label field -->
          <div class="form-group">
            <label class="form-group__label" for="mapping-label">Label <span aria-hidden="true">*</span></label>
            <input
              id="mapping-label"
              type="text"
              class="form-group__input"
              x-model="label"
              placeholder="e.g. Title"
            />
          </div>

          <!-- ADO Selector field -->
          <div class="form-group">
            <label class="form-group__label" for="mapping-ado-selector">ADO Selector <span aria-hidden="true">*</span></label>
            <input
              id="mapping-ado-selector"
              type="text"
              class="form-group__input"
              x-model="adoSelector"
              placeholder="e.g. input[aria-label='Title']"
            />
          </div>

          <!-- Field Schema Name (PA) field + Phase 8 / 9 deferred buttons -->
          <div class="form-group">
            <label class="form-group__label" for="mapping-field-schema-name">Field Schema Name (PA) <span aria-hidden="true">*</span></label>
            <div class="form-group__row">
              <input
                id="mapping-field-schema-name"
                type="text"
                class="form-group__input"
                x-model="fieldSchemaName"
                placeholder="e.g. cr123_lineofbusiness"
              />
              <!--
                "Pick from Page" (Phase 8) and "Test Field" (Phase 9) buttons
                are present but disabled as non-functional placeholders so the
                layout slot is reserved and the buttons are discoverable in the
                UI. They will be wired in later phases. (design Non-Goals)
              -->
              <button class="btn btn--small btn--secondary" disabled title="Available in Phase 8">Pick from Page</button>
              <button class="btn btn--small btn--secondary" disabled title="Available in Phase 9">Test Field</button>
            </div>
          </div>

          <!-- Field Type select -->
          <div class="form-group">
            <label class="form-group__label" for="mapping-field-type">Field Type <span aria-hidden="true">*</span></label>
            <select
              id="mapping-field-type"
              class="form-group__select"
              x-model="fieldType"
            >
              <option value="text">text</option>
              <option value="lookup">lookup</option>
              <option value="choice">choice</option>
            </select>
          </div>

          <!-- Inline validation error â€” Task 6.4 -->
          <!--
            x-show hides the element when formError is empty (falsy).
            x-text populates the message without innerHTML injection risk.
          -->
          <p class="inline-error" x-show="formError" x-text="formError"></p>

          <!-- Save + Cancel buttons â€” Task 6.5 -->
          <div class="mapping-form__actions">
            <button class="btn btn--primary" @click="save()">Save</button>
            <button class="btn btn--secondary" @click="$store.app.closeForm()">Cancel</button>
          </div>

        </div><!-- /mapping-form -->

      </section><!-- /mapping-section -->

      <!-- â”€â”€ Export / Import Placeholders (Phase 6) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!--
        Task 7.1 â€” Buttons are visible but non-functional.
        No @click handler is attached; they do nothing when clicked.
        Full implementation is deferred to Phase 6.
      -->
      <section class="import-export-bar">
        <button class="btn btn--secondary" disabled>â†“ Export Mappings</button>
        <button class="btn btn--secondary" disabled>â†‘ Import Mappings</button>
      </section>

    </div><!-- /tab-admin -->

  </div><!-- /app -->

</body>
</html>
